name: Python CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest] # Added windows-latest
        python-version: ["3.12"]

    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    - name: Install dependencies and pre-commit hooks
      run: |
        python -m pip install --upgrade pip
        pip install -e . pre-commit # Install pre-commit for running local hooks
        # Ruff needs to be installed in the venv for pre-commit hooks
        pip install ruff
        pre-commit install # Install local hooks
    - name: Run pre-commit hooks (Ruff, YAML, Whitespace, Pytest, Shellcheck)
      run: pre-commit run --all-files || (git status --short ; git diff ; exit 1)
      # The above ensures fixes are applied and committed or pipeline fails
    - name: Run Pytest
      run: pytest

  build-windows-installer:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ["3.10"] # Use a specific Python version for stability
        architecture: ["x64", "x86"] # Build for both 64-bit and 32-bit Windows

    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }} (${{ matrix.architecture }})
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        architecture: ${{ matrix.architecture }} # Specify 32-bit or 64-bit Python
        cache: 'pip'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    - name: Install NSIS
      run: choco install nsis --no-progress
    - name: Build Windows Executable and Installer (${{ matrix.architecture }})
      run: |
        chmod +x host/windows/build.sh
        ./host/windows/build.sh ${{ matrix.architecture }}
    - name: Upload NSIS Installer (${{ matrix.architecture }})
      uses: actions/upload-artifact@v4
      with:
        name: LiteAgentCLI_Installer_${{ matrix.architecture }}
        path: host/windows/LiteAgentCLI_Installer_${{ matrix.architecture }}.exe
    - name: Test NSIS Installer (${{ matrix.architecture }})
      # Test the generated installer silently
      shell: powershell
      run: |
        $InstallerPath = "host\windows\LiteAgentCLI_Installer_${{ matrix.architecture }}.exe"
        $InstallDir = "$env:TEMP\LiteAgentCLI_TestInstall_${{ matrix.architecture }}"

        Write-Host "Running installer: $InstallerPath"
        Write-Host "Installing to: $InstallDir"

        # Ensure target directory is clean before installation
        if (Test-Path $InstallDir) {
            Remove-Item -Path $InstallDir -Recurse -Force
        }

        # Run installer silently
        if (-not (Test-Path $InstallerPath)) {
            Write-Error "Installer file not found at $InstallerPath!"
            exit 1
        }
        Start-Process -FilePath $InstallerPath -ArgumentList "/S /D=$InstallDir" -Wait -NoNewWindow

        # Verify installation
        if (-not (Test-Path "$InstallDir\esl-harness.exe")) {
            Write-Error "esl-harness.exe not found after installation!"
            exit 1
        }
        Write-Host "esl-harness.exe found at $InstallDir"

        # Test basic commands
        Set-Location $InstallDir
        Write-Host "Running esl-harness.exe --help"
        .\esl-harness.exe --help | Out-Host # Output to console
        if ($LASTEXITCODE -ne 0) {
            Write-Error "esl-harness.exe --help failed!"
            exit 1
        }
        Write-Host "Running esl-harness.exe doctor"
        .\esl-harness.exe doctor | Out-Host # Output to console
        if ($LASTEXITCODE -ne 0) {
            Write-Error "esl-harness.exe doctor failed!"
            exit 1
        }

        # Run uninstaller silently
        Write-Host "Running uninstaller..."
        Start-Process -FilePath "$InstallDir\Uninstall.exe" -ArgumentList "/S" -Wait -NoNewWindow

        # Verify uninstallation
        Start-Sleep -Seconds 2 # Give some time for uninstallation to complete
        if (Test-Path $InstallDir) {
            Write-Error "Installation directory $InstallDir still exists after uninstallation!"
            exit 1
        }
        Write-Host "Uninstallation verified. Directory $InstallDir removed."
