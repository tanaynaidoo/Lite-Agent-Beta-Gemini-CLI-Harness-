name: Python CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest] # Added windows-latest
        python-version: ["3.12"]

    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        # Removed cache: 'pip'
    - name: Install dependencies and pre-commit hooks
      run: |
        python -m pip install --upgrade pip
        pip install -e . pre-commit pytest # Install pre-commit for running local hooks and pytest for main tests
        # Ruff needs to be installed in the venv for pre-commit hooks
        pip install ruff
        pre-commit install # Install local hooks
    - name: Run pre-commit hooks (Ruff, YAML, Whitespace, Pytest, Shellcheck)
      shell: bash
      run: pre-commit run --all-files || (git status --short ; git diff ; exit 1)
      # The above ensures fixes are applied and committed or pipeline fails
    - name: Run Pytest
      run: python -m pytest

  build-windows-installer:
    runs-on: windows-latest
    timeout-minutes: 10
    strategy:
      matrix:
        python-version: ["3.12"] # Use a specific Python version for stability
        architecture: ["x64", "x86"] # Build for both 64-bit and 32-bit Windows

    steps:
    - uses: actions/checkout@v4
    - name: Manual Python Setup (${{ matrix.architecture }})
      shell: powershell
      run: |
        $pythonVersion = "3.12.10"
        $architecture = "${{ matrix.architecture }}"
        $pythonZipName = "python-${pythonVersion}-embed-"

        if ($architecture -eq "x64") {
            $pythonZipName += "amd64.zip"
        } elseif ($architecture -eq "x86") {
            $pythonZipName += "win32.zip"
        } else {
            Write-Error "Unsupported architecture: $architecture"
            exit 1
        }

        $pythonDownloadUrl = "https://www.python.org/ftp/python/${pythonVersion}/${pythonZipName}"
        $pythonInstallDir = "$env:TEMP\python-${pythonVersion}-${architecture}"

        Write-Host "Downloading Python from: $pythonDownloadUrl"
        Invoke-WebRequest -Uri $pythonDownloadUrl -OutFile "$env:TEMP\$pythonZipName"

        Write-Host "Extracting Python to: $pythonInstallDir"
        Expand-Archive -Path "$env:TEMP\$pythonZipName" -DestinationPath $pythonInstallDir -Force

        Write-Host "Adding Python to PATH for this session"
        $env:Path = "$pythonInstallDir;$env:Path"
        Write-Host "Python setup complete. Python executable: (Get-Command python).Source"
    - name: Install dependencies
      shell: bash
      timeout-minutes: 10
      run: |
        python -m pip install --upgrade pip --no-input
        pip install -e .
    - name: Install NSIS
      run: choco install nsis --no-progress
    - name: Build Windows Executable and Installer (${{ matrix.architecture }})
      shell: bash
      run: |
        bash host/windows/build.sh ${{ matrix.architecture }}
    - name: Upload Build Debug Log (${{ matrix.architecture }})
      uses: actions/upload-artifact@v4
      with:
        name: Build_Debug_Log_${{ matrix.architecture }}
        path: host/windows/build_debug_${{ matrix.architecture }}.log
    - name: Upload NSIS Installer (${{ matrix.architecture }})
      uses: actions/upload-artifact@v4
      with:
        name: LiteAgentCLI_Installer_${{ matrix.architecture }}
        path: host/windows/LiteAgentCLI_Installer_${{ matrix.architecture }}.exe
    - name: Test NSIS Installer (${{ matrix.architecture }})
      # Test the generated installer silently
      shell: powershell
      run: |
        $InstallerPath = "host\windows\LiteAgentCLI_Installer_${{ matrix.architecture }}.exe"
        $InstallDir = "$env:TEMP\LiteAgentCLI_TestInstall_${{ matrix.architecture }}"

        Write-Host "Running installer: $InstallerPath"
        Write-Host "Installing to: $InstallDir"

        # Ensure target directory is clean before installation
        if (Test-Path $InstallDir) {
            Remove-Item -Path $InstallDir -Recurse -Force
        }

        # Run installer silently
        Write-Host "Checking for installer at: $InstallerPath"
        if (-not (Test-Path $InstallerPath)) {
            Write-Host "Installer file DOES NOT exist at $InstallerPath!"
            Write-Error "Installer file not found at $InstallerPath!"
            exit 1
        }
        Write-Host "Installer file EXISTS at $InstallerPath."
        Start-Process -FilePath $InstallerPath -ArgumentList "/S /D=$InstallDir" -Wait -NoNewWindow

        # Verify installation
        if (-not (Test-Path "$InstallDir\esl-harness.exe")) {
            Write-Error "esl-harness.exe not found after installation!"
            exit 1
        }
        Write-Host "esl-harness.exe found at $InstallDir"

        # Test basic commands
        Set-Location $InstallDir
        Write-Host "Running esl-harness.exe --help"
        .\esl-harness.exe --help | Out-Host # Output to console
        if ($LASTEXITCODE -ne 0) {
            Write-Error "esl-harness.exe --help failed!"
            exit 1
        }
        Write-Host "Running esl-harness.exe doctor"
        .\esl-harness.exe doctor | Out-Host # Output to console
        if ($LASTEXITCODE -ne 0) {
            Write-Error "esl-harness.exe doctor failed!"
            exit 1
        }

        # Run uninstaller silently
        Write-Host "Running uninstaller..."
        Start-Process -FilePath "$InstallDir\Uninstall.exe" -ArgumentList "/S" -Wait -NoNewWindow

        # Verify uninstallation
        Start-Sleep -Seconds 2 # Give some time for uninstallation to complete
        if (Test-Path $InstallDir) {
            Write-Error "Installation directory $InstallDir still exists after uninstallation!"
            exit 1
        }
        Write-Host "Uninstallation verified. Directory $InstallDir removed."
